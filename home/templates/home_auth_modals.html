{% load static %}

{% block extra_header_js %}
<!-- jQuery (full version) with integrity check -->
<script 
    src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
    crossorigin="anonymous" 
    defer>
</script>

<!-- International Telephone Input -->
<script 
    src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"
    integrity="sha512-DNeDhsl+FWnx5B1EQzsayHMyP6Xl/Mg+vcnFPXGNjUZrW28hQaa1+A4qL9M+AiOMmkAhKAWYHh1a+t6qxthzUw=="
    crossorigin="anonymous"
    defer>
</script>

<script 
    src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
    defer>
</script>

<!-- Add IntlTelInput CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

<!-- Add Custom CSS -->
<style>
    .auth-modal {
        --modal-padding: 1.5rem;
        --input-border-radius: 4px;
        --transition-speed: 0.3s;
    }

    .auth-modal .modal-content {
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .auth-modal .modal-header {
        border-bottom: none;
        padding: var(--modal-padding);
    }

    .auth-modal .modal-body {
        padding: 0 var(--modal-padding) var(--modal-padding);
    }

    .auth-messages {
        margin-bottom: 1rem;
    }

    .auth-messages .alert {
        margin-bottom: 0.5rem;
        border-radius: var(--input-border-radius);
    }

    .auth-form .form-control {
        border-radius: var(--input-border-radius);
        padding: 0.75rem 1rem;
        transition: border-color var(--transition-speed);
    }

    .auth-form .form-control:focus {
        box-shadow: none;
        border-color: var(--bs-primary);
    }

    .password-strength {
        height: 4px;
        margin-top: 0.5rem;
        border-radius: 2px;
        transition: width var(--transition-speed);
    }

    .loading-spinner {
        display: inline-block;
        margin-right: 0.5rem;
    }

    .iti {
        width: 100%;
    }

    /* Accessibility focus styles */
    .auth-form .form-control:focus-visible {
        outline: 2px solid var(--bs-primary);
        outline-offset: 2px;
    }

    /* Animation for modal transition */
    .modal.fade .modal-dialog {
        transform: scale(0.95);
        transition: transform var(--transition-speed);
    }

    .modal.show .modal-dialog {
        transform: scale(1);
    }
</style>
{% endblock %}

<!-- Sign In Modal -->
<div class="modal fade auth-modal" id="signModal" tabindex="-1" role="dialog" 
     aria-labelledby="signModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header m-header">
                <div class="m-log">
                    <img src="{% static 'home_assets/media/logo-red.svg' %}" alt="">
                </div>
                <h3 class="sub-mod-head">Sign In to your Account</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="auth-form">
                    <div id="signin-messages" class="auth-messages" 
                         aria-live="polite"></div>
                    <form id="signin-form" novalidate>
                        {% csrf_token %}
                        <div class="input-area-contact">
                            <div class="form-group mb-3">
                                <input type="email" name="email" id="signin-email" 
                                       class="form-control" placeholder="Email" 
                                       required aria-required="true"
                                       autocomplete="email">
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="form-group mb-3">
                                <div class="input-group">
                                    <input type="password" name="password" 
                                           id="signin-password" 
                                           class="form-control" 
                                           placeholder="Password" required 
                                           aria-required="true"
                                           autocomplete="current-password">
                                    <button type="button" 
                                            class="btn btn-outline-secondary toggle-password" 
                                            aria-label="Toggle password visibility">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <div class="fp">
                            <a href="#" id="forgot-password-link" 
                               class="text-decoration-none switch-modal" data-target="forgotPasswordModal">Forgot Password?</a>
                        </div><br>
                        <button class="buy-now" type="submit">
                            <span class="button-text">Sign in</span>
                            <span class="loading-spinner d-none">
                                <span class="spinner-border spinner-border-sm" 
                                      role="status" aria-hidden="true"></span>
                                Signing in...
                            </span>
                        </button><br>
                        <div class="reg">
                            <a href="#" class="switch-modal text-decoration-none" 
                               data-target="signUpModal">
                                Don't have an account? Sign Up
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sign Up Modal -->
<div class="modal fade auth-modal" id="signUpModal" tabindex="-1" role="dialog" 
     aria-labelledby="signUpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header m-header">
                <div class="m-log">
                    <img src="{% static 'home_assets/media/logo-red.svg' %}" alt="">
                </div>
                <h3 class="sub-mod-head">Sign Up for an Account</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="auth-form">
                    <div id="signup-messages" class="auth-messages" 
                         aria-live="polite"></div>
                    <form id="signup-form" novalidate>
                        {% csrf_token %}
                        <div class="input-area-contact">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <input type="text" name="first_name" 
                                           id="signup-firstname" 
                                           class="form-control" 
                                           placeholder="First Name" required 
                                           aria-required="true"
                                           autocomplete="given-name">
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <input type="text" name="last_name" 
                                           id="signup-lastname" 
                                           class="form-control" 
                                           placeholder="Last Name" required 
                                           aria-required="true"
                                           autocomplete="family-name">
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <input type="email" name="email" id="signup-email" 
                                       class="form-control" placeholder="Email" 
                                       required aria-required="true"
                                       autocomplete="email">
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="form-group mb-3">
                                <input type="text" name="username" 
                                       id="signup-username" class="form-control" 
                                       placeholder="Username" required 
                                       aria-required="true"
                                       autocomplete="username">
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="form-group mb-3">
                                <input type="tel" name="phone" id="phone" 
                                       class="form-control" required 
                                       aria-required="true"
                                       autocomplete="tel">
                                <input type="hidden" name="phone_country_code" 
                                       id="phone_country_code">
                                <input type="hidden" name="full_phone_number" 
                                       id="full_phone_number">
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="form-group mb-3">
                                <div class="input-group">
                                    <input type="password" name="password" 
                                           id="signup-password" 
                                           class="form-control" 
                                           placeholder="Password" required 
                                           aria-required="true"
                                           autocomplete="new-password">
                                    <button type="button" 
                                            class="btn btn-outline-secondary toggle-password" 
                                            aria-label="Toggle password visibility">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="form-group mb-3">
                                <div class="input-group">
                                    <input type="password" name="confirm_password" 
                                           id="signup-confirm-password" 
                                           class="form-control" 
                                           placeholder="Confirm Password" required 
                                           aria-required="true"
                                           autocomplete="new-password">
                                    <button type="button" 
                                            class="btn btn-outline-secondary toggle-password" 
                                            aria-label="Toggle password visibility">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <button class="buy-now" type="submit">
                            <span class="button-text">Sign Up</span>
                            <span class="loading-spinner d-none">
                                <span class="spinner-border spinner-border-sm" 
                                      role="status" aria-hidden="true"></span>
                                Signing up...
                            </span>
                        </button>
                        <div class="reg">
                            <a href="#" class="switch-modal text-decoration-none" 
                               data-target="signModal">
                                Already have an account? Sign In
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Forgot Password Modal -->
<div class="modal fade auth-modal" id="forgotPasswordModal" tabindex="-1" role="dialog" 
     aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header m-header">
                <div class="m-log">
                    <img src="{% static 'home_assets/media/logo-red.svg' %}" alt="">
                </div>
                <h3 class="sub-mod-head">Forgot Password</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="auth-form">
                    <div id="forgot-password-messages" class="auth-messages" aria-live="polite"></div>
                    <form id="forgot-password-form" novalidate>
                        {% csrf_token %}
                        <div class="input-area-contact">
                            <div class="form-group mb-3">
                                <input type="email" name="email" id="forgot-password-email" 
                                       class="form-control" placeholder="Enter your email" 
                                       required aria-required="true" autocomplete="email">
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <button class="buy-now" type="submit">
                            <span class="button-text">Send OTP</span>
                            <span class="loading-spinner d-none">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Sending...
                            </span>
                        </button>
                        <div class="reg">
                            <a href="#" class="switch-modal text-decoration-none" data-target="signModal">
                                Back to Sign In
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OTP Verification Modal -->
<div class="modal fade auth-modal" id="otpModal" tabindex="-1" role="dialog" 
     aria-labelledby="otpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header m-header">
                <div class="m-log">
                    <img src="{% static 'home_assets/media/logo-red.svg' %}" alt="">
                </div>
                <h3 class="sub-mod-head">Verify OTP</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="auth-form">
                    <div id="otp-messages" class="auth-messages" aria-live="polite"></div>
                    <form id="otp-form" novalidate>
                        {% csrf_token %}
                        <div class="input-area-contact">
                            <div class="form-group mb-3">
                                <input type="text" name="otp" id="otp-input" 
                                       class="form-control" placeholder="Enter OTP" 
                                       required aria-required="true" maxlength="6">
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <button class="buy-now" type="submit">
                            <span class="button-text">Verify OTP</span>
                            <span class="loading-spinner d-none">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Verifying...
                            </span>
                        </button>
                        <div class="reg">
                            <a href="#" class="switch-modal text-decoration-none" data-target="forgotPasswordModal">
                                Resend OTP
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade auth-modal" id="resetPasswordModal" tabindex="-1" role="dialog" 
     aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header m-header">
                <div class="m-log">
                    <img src="{% static 'home_assets/media/logo-red.svg' %}" alt="">
                </div>
                <h3 class="sub-mod-head">Reset Password</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="auth-form">
                    <div id="reset-password-messages" class="auth-messages" aria-live="polite"></div>
                    <form id="reset-password-form" novalidate>
                        {% csrf_token %}
                        <div class="input-area-contact">
                            <div class="form-group mb-3">
                                <div class="input-group">
                                    <input type="password" name="password" id="reset-password" 
                                           class="form-control" placeholder="New Password" 
                                           required aria-required="true" autocomplete="new-password">
                                    <button type="button" class="btn btn-outline-secondary toggle-password" 
                                            aria-label="Toggle password visibility">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="form-group mb-3">
                                <div class="input-group">
                                    <input type="password" name="confirm_password" id="reset-confirm-password" 
                                           class="form-control" placeholder="Confirm Password" 
                                           required aria-required="true" autocomplete="new-password">
                                    <button type="button" class="btn btn-outline-secondary toggle-password" 
                                            aria-label="Toggle password visibility">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <button class="buy-now" type="submit">
                            <span class="button-text">Reset Password</span>
                            <span class="loading-spinner d-none">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Resetting...
                            </span>
                        </button>
                        <div class="reg">
                            <a href="#" class="switch-modal text-decoration-none" data-target="signModal">
                                Back to Sign In
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Utility functions
    const getCookie = name => {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };

    const displayMessage = (containerId, type, message, isHtml = false) => {
        const messagesDiv = document.getElementById(containerId);
        messagesDiv.innerHTML = ''; // Clear previous messages
        
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.setAttribute('role', 'alert');
        
        if (isHtml) {
            alert.innerHTML = message;
        } else {
            alert.textContent = message;
        }
        
        const closeButton = document.createElement('button');
        closeButton.type = 'button';
        closeButton.className = 'btn-close';
        closeButton.setAttribute('data-bs-dismiss', 'alert');
        closeButton.setAttribute('aria-label', 'Close');
        
        alert.appendChild(closeButton);
        messagesDiv.appendChild(alert);
    };

    // Password strength checker
    const checkPasswordStrength = (password) => {
        let strength = 0;
        const checks = {
            length: password.length >= 8,
            hasUpperCase: /[A-Z]/.test(password),
            hasLowerCase: /[a-z]/.test(password),
            hasNumbers: /\d/.test(password),
            hasSpecialChars: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        strength += Object.values(checks).filter(Boolean).length;
        
        const strengthMeter = document.querySelector('.password-strength-meter .progress-bar');
        const strengthText = document.querySelector('.password-strength-text');
        
        const strengthLabels = ['Too weak', 'Weak', 'Fair', 'Good', 'Strong'];
        const strengthColors = ['danger', 'warning', 'info', 'primary', 'success'];
        
        const index = Math.min(strength - 1, 4);
        
        if (strengthMeter && strengthText) {
            strengthMeter.style.width = `${(strength / 5) * 100}%`;
            strengthMeter.className = `progress-bar bg-${strengthColors[index]}`;
            strengthText.textContent = `Password strength: ${strengthLabels[index]}`;
        }
        
        return strength;
    };

    // Initialize phone input
    const phoneInput = document.querySelector("#phone");
    let iti = null;
    
    if (phoneInput) {
        iti = window.intlTelInput(phoneInput, {
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
            separateDialCode: true,
            initialCountry: "auto",
            geoIpLookup: function(callback) {
                fetch("https://ipapi.co/json")
                    .then(res => res.json())
                    .then(data => callback(data.country_code))
                    .catch(() => callback("US"));
            },
        });
    }

    // Modal handling
    const modals = {
        signModal: new bootstrap.Modal(document.getElementById('signModal')),
        signUpModal: new bootstrap.Modal(document.getElementById('signUpModal')),
        forgotPasswordModal: new bootstrap.Modal(document.getElementById('forgotPasswordModal')),
        otpModal: new bootstrap.Modal(document.getElementById('otpModal')),
        resetPasswordModal: new bootstrap.Modal(document.getElementById('resetPasswordModal'))
    };

    // Modal switching
    document.querySelectorAll('.switch-modal').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const targetModalId = this.getAttribute('data-target');
            
            // Hide all modals
            Object.values(modals).forEach(modal => modal.hide());
            
            // Show target modal
            if (modals[targetModalId]) {
                modals[targetModalId].show();
            }
        });
    });

    // Password visibility toggle (handles all .toggle-password elements)
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const input = this.closest('.input-group').querySelector('input');
            const icon = this.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });
    });

    // Real-time password strength check
    const signupPassword = document.getElementById('signup-password');
    if (signupPassword) {
        signupPassword.addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });
    }

    const resetPassword = document.getElementById('reset-password');
    if (resetPassword) {
        resetPassword.addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });
    }

    // Sign In Form Handler
    const signinForm = document.getElementById('signin-form');
    if (signinForm) {
        signinForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Clear previous messages
            document.getElementById('signin-messages').innerHTML = '';
            
            // Get form elements
            const submitButton = this.querySelector('button[type="submit"]');
            const buttonText = submitButton.querySelector('.button-text');
            const loadingSpinner = submitButton.querySelector('.loading-spinner');
            
            // Get form data
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;

            // Basic validation
            if (!email || !password) {
                displayMessage('signin-messages', 'danger', 'Please fill in all required fields');
                return;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                displayMessage('signin-messages', 'danger', 'Please enter a valid email address');
                return;
            }

            // Show loading state
            submitButton.disabled = true;
            buttonText.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');

            try {
                const response = await fetch('/customer/signin/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ email, password }),
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.status === 'success') {
                    displayMessage('signin-messages', 'success', 'Sign in successful!');
                    
                    // Redirect or reload after successful login
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } 
                else if (data.status === 'session_cleared') {
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            displayMessage('signin-messages', msg.tags, msg.message);
                        });
                    }
                    
                    // Reload page after session cleared message
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } 
                else {
                    displayMessage('signin-messages', 'danger', data.message || 'Sign in failed');
                }
            } catch (error) {
                console.error('Error:', error);
                displayMessage('signin-messages', 'danger', 'An unexpected error occurred. Please try again.');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                buttonText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
            }
        });
    }

    // Sign Up Form Handler
    const signupForm = document.getElementById('signup-form');
    if (signupForm) {
        signupForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Clear previous messages
            document.getElementById('signup-messages').innerHTML = '';
            
            // Get form elements
            const submitButton = this.querySelector('button[type="submit"]');
            const buttonText = submitButton.querySelector('.button-text');
            const loadingSpinner = submitButton.querySelector('.loading-spinner');

            // Get form data
            const formData = {
                first_name: document.getElementById('signup-firstname').value.trim(),
                last_name: document.getElementById('signup-lastname').value.trim(),
                email: document.getElementById('signup-email').value.trim(),
                username: document.getElementById('signup-username').value.trim(),
                password: document.getElementById('signup-password').value,
                confirm_password: document.getElementById('signup-confirm-password').value
            };

            // Basic validation
            for (const [key, value] of Object.entries(formData)) {
                if (!value) {
                    displayMessage('signup-messages', 'danger', 'Please fill in all required fields');
                    return;
                }
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(formData.email)) {
                displayMessage('signup-messages', 'danger', 'Please enter a valid email address');
                return;
            }

            // Username validation
            if (formData.username.length < 3 || !/^[\w.@+-]+$/.test(formData.username)) {
                displayMessage('signup-messages', 'danger', 'Username must be at least 3 characters and contain only letters, numbers, and @/./+/-/_');
                return;
            }

            // Password validation
            if (formData.password !== formData.confirm_password) {
                displayMessage('signup-messages', 'danger', 'Passwords do not match');
                return;
            }

            if (checkPasswordStrength(formData.password) < 3) {
                displayMessage('signup-messages', 'danger', 'Please choose a stronger password');
                return;
            }

            // Phone validation
            if (iti) {
                if (!iti.isValidNumber()) {
                    displayMessage('signup-messages', 'danger', 'Please enter a valid phone number');
                    return;
                }
                formData.phone = iti.getNumber();
                formData.phone_country_code = iti.getSelectedCountryData().dialCode;
            }

            // Show loading state
            submitButton.disabled = true;
            buttonText.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');

            try {
                const response = await fetch('/customer/signup/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData),
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.status === 'success') {
                    displayMessage('signup-messages', 'success', 'Account created successfully!');
                    
                    // Switch to sign in modal after delay
                    setTimeout(() => {
                        modals.signUpModal.hide();
                        setTimeout(() => {
                            modals.signModal.show();
                            displayMessage('signin-messages', 'success', 'Please sign in with your new account');
                        }, 500);
                    }, 2000);
                } else {
                    displayMessage('signup-messages', 'danger', data.message || 'Sign up failed');
                }
            } catch (error) {
                console.error('Error:', error);
                displayMessage('signup-messages', 'danger', 'An unexpected error occurred. Please try again.');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                buttonText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
            }
        });
    }

    // Forgot Password Form Handler
    const forgotPasswordForm = document.getElementById('forgot-password-form');
    let resetEmail = ''; // Store email for OTP and password reset
    if (forgotPasswordForm) {
        forgotPasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Clear previous messages
            document.getElementById('forgot-password-messages').innerHTML = '';
            
            // Get form elements
            const submitButton = this.querySelector('button[type="submit"]');
            const buttonText = submitButton.querySelector('.button-text');
            const loadingSpinner = submitButton.querySelector('.loading-spinner');
            
            // Get form data
            resetEmail = document.getElementById('forgot-password-email').value.trim();

            // Basic validation
            if (!resetEmail) {
                displayMessage('forgot-password-messages', 'danger', 'Please enter your email');
                return;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(resetEmail)) {
                displayMessage('forgot-password-messages', 'danger', 'Please enter a valid email address');
                return;
            }

            // Show loading state
            submitButton.disabled = true;
            buttonText.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');

            try {
                const response = await fetch('/customer/forgot-password/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ email: resetEmail }),
                    credentials: 'same-origin'
                });

                const data = await response.json();
                console.log('Forgot Password Response:', data); // Debug response

                // Display the message from the backend
                const messageType = data.status === 'success' ? 'success' : 'danger';
                displayMessage('forgot-password-messages', messageType, data.message || 'An error occurred');

                // Only transition to OTP modal if OTP was actually sent
                if (data.status === 'success' && data.message.includes('OTP sent') && !data.message.includes('If an account exists')) {
                    console.log('Transitioning to OTP modal');
                    setTimeout(() => {
                        modals.forgotPasswordModal.hide();
                        setTimeout(() => {
                            if (!modals.otpModal) {
                                console.error('otpModal is not initialized');
                                displayMessage('forgot-password-messages', 'danger', 'Failed to open OTP modal. Please try again.');
                                return;
                            }
                            console.log('Opening otpModal');
                            modals.otpModal.show();
                        }, 500);
                    }, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
                displayMessage('forgot-password-messages', 'danger', 'An unexpected error occurred. Please try again.');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                buttonText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
            }
        });
    }

    // OTP Form Handler
    const otpForm = document.getElementById('otp-form');
    if (otpForm) {
        otpForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Clear previous messages
            document.getElementById('otp-messages').innerHTML = '';
            
            // Get form elements
            const submitButton = this.querySelector('button[type="submit"]');
            const buttonText = submitButton.querySelector('.button-text');
            const loadingSpinner = submitButton.querySelector('.loading-spinner');
            
            // Get form data
            const otp = document.getElementById('otp-input').value.trim();

            // Basic validation
            if (!otp || otp.length !== 6 || !/^\d{6}$/.test(otp)) {
                displayMessage('otp-messages', 'danger', 'Please enter a valid 6-digit OTP');
                return;
            }

            // Show loading state
            submitButton.disabled = true;
            buttonText.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');

            try {
                const response = await fetch('/customer/verify-otp/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ email: resetEmail, otp }),
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.status === 'success') {
                    displayMessage('otp-messages', 'success', 'OTP verified successfully!');
                    setTimeout(() => {
                        modals.otpModal.hide();
                        setTimeout(() => {
                            modals.resetPasswordModal.show();
                        }, 500);
                    }, 1000);
                } else {
                    displayMessage('otp-messages', 'danger', data.message || 'Invalid OTP');
                }
            } catch (error) {
                console.error('Error:', error);
                displayMessage('otp-messages', 'danger', 'An unexpected error occurred. Please try again.');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                buttonText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
            }
        });
    }

    // Reset Password Form Handler
    const resetPasswordForm = document.getElementById('reset-password-form');
    if (resetPasswordForm) {
        resetPasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Clear previous messages
            document.getElementById('reset-password-messages').innerHTML = '';
            
            // Get form elements
            const submitButton = this.querySelector('button[type="submit"]');
            const buttonText = submitButton.querySelector('.button-text');
            const loadingSpinner = submitButton.querySelector('.loading-spinner');
            
            // Get form data
            const password = document.getElementById('reset-password').value;
            const confirmPassword = document.getElementById('reset-confirm-password').value;

            // Basic validation
            if (!password || !confirmPassword) {
                displayMessage('reset-password-messages', 'danger', 'Please fill in all required fields');
                return;
            }

            if (password !== confirmPassword) {
                displayMessage('reset-password-messages', 'danger', 'Passwords do not match');
                return;
            }

            if (checkPasswordStrength(password) < 3) {
                displayMessage('reset-password-messages', 'danger', 'Please choose a stronger password');
                return;
            }

            // Show loading state
            submitButton.disabled = true;
            buttonText.classList.add('d-none');
            loadingSpinner.classList.remove('d-none');

            try {
                const response = await fetch('/customer/reset-password/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ email: resetEmail, password }),
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.status === 'success') {
                    displayMessage('reset-password-messages', 'success', 'Password reset successfully!');
                    setTimeout(() => {
                        modals.resetPasswordModal.hide();
                        setTimeout(() => {
                            modals.signModal.show();
                            displayMessage('signin-messages', 'success', 'Please sign in with your new password');
                        }, 500);
                    }, 2000);
                } else {
                    displayMessage('reset-password-messages', 'danger', data.message || 'Failed to reset password');
                }
            } catch (error) {
                console.error('Error:', error);
                displayMessage('reset-password-messages', 'danger', 'An unexpected error occurred. Please try again.');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                buttonText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
            }
        });
    }
});
</script>